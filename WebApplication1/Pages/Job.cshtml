@page
@using WebApplication1.Models
@model WebApplication1.Pages.JobsModel
@{
    ViewData["Title"] = "Співробітники станції";
    var departments = new[] { "Логістика", "Управління рухомим складом", "Адміністрація", "Технічний відділ" };
    var positions = new[] { "Диспетчер", "Машиніст", "Інженер", "Менеджер", "Начальник відділу" };
    var brigades = new[] { "Ремонтна бригада №1", "Ремонтна бригада №2", "Локомотивна бригада №1", "Локомотивна бригада №2" };
}

<h2 class="mb-3">Співробітники станції</h2>

<div class="d-flex gap-2 mb-3">
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addModal">+ Додати співробітника</button>
    <button class="btn btn-secondary" onclick="toggleFilters()">Показати фільтри</button>
    <button class="btn btn-outline-secondary" onclick="resetFilters()">Скинути фільтри</button>
</div>

<div id="filterPanel" class="card mb-3 d-none">
    <div class="card-body">
        <div class="row g-2">
            <div class="col-md-3"><input class="form-control form-control-sm" id="f_last_name" oninput="applyFilters()" placeholder="Прізвище" /></div>
            <div class="col-md-3"><input class="form-control form-control-sm" id="f_department" oninput="applyFilters()" placeholder="Відділ" /></div>
            <div class="col-md-3"><input class="form-control form-control-sm" id="f_position" oninput="applyFilters()" placeholder="Посада" /></div>
            <div class="col-md-3">
                <select class="form-select form-select-sm" id="f_gender" onchange="applyFilters()">
                    <option value="">Стать (будь-яка)</option>
                    <option>Чоловік</option>
                    <option>Жінка</option>
                </select>
            </div>
            <div class="col-md-3"><input class="form-control form-control-sm" id="f_salary_min" type="number" oninput="applyFilters()" placeholder="Оклад від (грн)" /></div>
            <div class="col-md-3"><input class="form-control form-control-sm" id="f_salary_max" type="number" oninput="applyFilters()" placeholder="Оклад до (грн)" /></div>
            <div class="col-md-3"><input class="form-control form-control-sm" id="f_height_min" type="number" oninput="applyFilters()" placeholder="Зріст від (см)" /></div>
            <div class="col-md-3"><input class="form-control form-control-sm" id="f_children" type="number" oninput="applyFilters()" placeholder="Кількість дітей" /></div>
        </div>
    </div>
</div>

<p class="text-muted small">Співробітників: <span id="countLabel">@Model.Jobs.Count</span></p>

<div class="table-responsive">
    <table class="table table-bordered table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>ПІБ</th>
                <th>Пол</th>
                <th>Дата народження</th>
                <th>Зріст</th>
                <th>Діти</th>
                <th>Відділ</th>
                <th>Посада</th>
                <th>Бригада</th>
                <th>Прийнятий</th>
                <th>Оклад</th>
                <th>Дії</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var job in Model.Jobs)
            {
                var age = DateTime.Now.Year - job.birthday.Year - (DateTime.Now.DayOfYear < job.birthday.DayOfYear ? 1 : 0);
                var tenure = DateTime.Now.Year - job.hired.Year - (DateTime.Now.DayOfYear < job.hired.DayOfYear ? 1 : 0);
                var isMale = job.gender == "Чоловік";
                <tr class="job-row"
                    data-last_name="@job.last_name.ToLower()"
                    data-department="@job.department.ToLower()"
                    data-position="@job.position.ToLower()"
                    data-gender="@job.gender"
                    data-salary="@job.salary"
                    data-height="@job.height"
                    data-children="@job.children">
                    <td>@job.Id</td>
                    <td><strong>@job.last_name @job.first_name</strong><br /><small class="text-muted">@job.middle_name</small></td>
                    <td><span class="badge @(isMale ? "bg-primary" : "bg-danger")">@(isMale ? "М" : "Ж")</span></td>
                    <td>@job.birthday.ToShortDateString() <small class="text-muted">(@age р.)</small></td>
                    <td>@job.height см</td>
                    <td>@job.children</td>
                    <td>@job.department</td>
                    <td>@job.position</td>
                    <td>@job.brigade</td>
                    <td>@job.hired.ToShortDateString() <small class="text-muted">(@tenure р.)</small></td>
                    <td>@job.salary.ToString("N0") грн</td>
                    <td>
                        <button class="btn btn-warning btn-sm"
                                onclick="openEdit(@job.Id,'@job.last_name','@job.first_name','@job.middle_name','@job.gender','@job.birthday.ToString("yyyy-MM-dd")',@job.height,@job.children,'@job.department','@job.position','@job.brigade','@job.hired.ToString("yyyy-MM-dd")',@job.salary)">
                            Змінити
                        </button>
                        <button class="btn btn-danger btn-sm"
                                onclick="openDelete(@job.Id,'@job.last_name @job.first_name @job.middle_name')">
                            Видалити
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Додавання співробітника</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="?handler=Add">
                @Html.AntiForgeryToken()
                <div class="modal-body row g-3">
                    <div class="col-md-4"><label class="form-label">Прізвище</label><input class="form-control" name="CurrentJob.last_name" required /></div>
                    <div class="col-md-4"><label class="form-label">Ім'я</label><input class="form-control" name="CurrentJob.first_name" required /></div>
                    <div class="col-md-4"><label class="form-label">По батькові</label><input class="form-control" name="CurrentJob.middle_name" required /></div>
                    <div class="col-md-4">
                        <label class="form-label">Стать</label>
                        <div class="d-flex gap-3 pt-1">
                            <div class="form-check"><input class="form-check-input" type="radio" name="CurrentJob.gender" value="Чоловік" required /><label class="form-check-label">Чоловік</label></div>
                            <div class="form-check"><input class="form-check-input" type="radio" name="CurrentJob.gender" value="Жінка" /><label class="form-check-label">Жінка</label></div>
                        </div>
                    </div>
                    <div class="col-md-4"><label class="form-label">День народження</label><input class="form-control" type="date" name="CurrentJob.birthday" required /></div>
                    <div class="col-md-2"><label class="form-label">Зріст (см)</label><input class="form-control" type="number" name="CurrentJob.height" required /></div>
                    <div class="col-md-2"><label class="form-label">Діти</label><input class="form-control" type="number" name="CurrentJob.children" value="0" /></div>
                    <div class="col-md-4">
                        <label class="form-label">Відділ</label>
                        <select class="form-select" name="CurrentJob.department" required>
                            <option value="" disabled selected>Виберіть відділ</option>
                            @foreach (var d in departments)
                            {
                                <option>@d</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Посада</label>
                        <select class="form-select" name="CurrentJob.position" required>
                            <option value="" disabled selected>Виберіть посаду</option>
                            @foreach (var p in positions)
                            {
                                <option>@p</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Бригада</label>
                        <select class="form-select" name="CurrentJob.brigade" required>
                            <option value="" disabled selected>Виберіть бригаду</option>
                            @foreach (var b in brigades)
                            {
                                <option>@b</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-4"><label class="form-label">Прийнятий на роботу</label><input class="form-control" type="date" name="CurrentJob.hired" required /></div>
                    <div class="col-md-4"><label class="form-label">Оклад (грн)</label><input class="form-control" type="number" name="CurrentJob.salary" step="0.01" required /></div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Зберегти співробітника</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Назад</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Редагування співробітника</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body row g-3">
                @Html.AntiForgeryToken()
                <input type="hidden" id="editId" />
                <div class="col-md-4"><label class="form-label">Прізвище</label><input class="form-control" id="e_last_name" /></div>
                <div class="col-md-4"><label class="form-label">Ім'я</label><input class="form-control" id="e_first_name" /></div>
                <div class="col-md-4"><label class="form-label">По батькові</label><input class="form-control" id="e_middle_name" /></div>
                <div class="col-md-4">
                    <label class="form-label">Стать</label>
                    <div class="d-flex gap-3 pt-1">
                        <div class="form-check"><input class="form-check-input" type="radio" name="e_gender" id="e_m" value="Чоловік" /><label class="form-check-label" for="e_m">Чоловік</label></div>
                        <div class="form-check"><input class="form-check-input" type="radio" name="e_gender" id="e_f" value="Жінка" /><label class="form-check-label" for="e_f">Жінка</label></div>
                    </div>
                </div>
                <div class="col-md-4"><label class="form-label">День народження</label><input class="form-control" type="date" id="e_birthday" /></div>
                <div class="col-md-2"><label class="form-label">Зріст (см)</label><input class="form-control" type="number" id="e_height" /></div>
                <div class="col-md-2"><label class="form-label">Діти</label><input class="form-control" type="number" id="e_children" /></div>
                <div class="col-md-4">
                    <label class="form-label">Відділ</label>
                    <select class="form-select" id="e_department">
                        @foreach (var d in departments)
                        {
                            <option>@d</option>
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Посада</label>
                    <select class="form-select" id="e_position">
                        @foreach (var p in positions)
                        {
                            <option>@p</option>
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Бригада</label>
                    <select class="form-select" id="e_brigade">
                        @foreach (var b in brigades)
                        {
                            <option>@b</option>
                        }
                    </select>
                </div>
                <div class="col-md-4"><label class="form-label">Прийнятий на роботу</label><input class="form-control" type="date" id="e_hired" /></div>
                <div class="col-md-4"><label class="form-label">Оклад (грн)</label><input class="form-control" type="number" id="e_salary" /></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="submitEdit()">Зберегти зміни</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Назад</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Видалення співробітника</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning mb-0">Буде видалений: <strong id="deleteName"></strong></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="confirmDelete()">Видалити співробітника</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Назад</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function toggleFilters() {
            document.getElementById('filterPanel').classList.toggle('d-none');
        }

        function resetFilters() {
            ['f_last_name','f_department','f_position','f_salary_min','f_salary_max','f_height_min','f_children']
                .forEach(id => document.getElementById(id).value = '');
            document.getElementById('f_gender').value = '';
            applyFilters();
        }

        function applyFilters() {
            const v = {
                last_name:  document.getElementById('f_last_name').value.toLowerCase(),
                department: document.getElementById('f_department').value.toLowerCase(),
                position:   document.getElementById('f_position').value.toLowerCase(),
                gender:     document.getElementById('f_gender').value,
                salaryMin:  parseFloat(document.getElementById('f_salary_min').value) || 0,
                salaryMax:  parseFloat(document.getElementById('f_salary_max').value) || Infinity,
                heightMin:  parseInt(document.getElementById('f_height_min').value) || 0,
                children:   document.getElementById('f_children').value,
            };
            let count = 0;
            document.querySelectorAll('.job-row').forEach(row => {
                const show =
                    (!v.last_name  || row.dataset.last_name.includes(v.last_name)) &&
                    (!v.department || row.dataset.department.includes(v.department)) &&
                    (!v.position   || row.dataset.position.includes(v.position)) &&
                    (!v.gender     || row.dataset.gender === v.gender) &&
                    (parseFloat(row.dataset.salary) >= v.salaryMin) &&
                    (parseFloat(row.dataset.salary) <= v.salaryMax) &&
                    (parseInt(row.dataset.height)   >= v.heightMin) &&
                    (!v.children   || row.dataset.children === v.children);
                row.classList.toggle('d-none', !show);
                if (show) count++;
            });
            document.getElementById('countLabel').textContent = count;
        }

        function openEdit(id, last_name, first_name, middle_name, gender, birthday, height, children, department, position, brigade, hired, salary) {
            document.getElementById('editId').value         = id;
            document.getElementById('e_last_name').value    = last_name;
            document.getElementById('e_first_name').value   = first_name;
            document.getElementById('e_middle_name').value  = middle_name;
            document.querySelector(`input[name="e_gender"][value="${gender}"]`).checked = true;
            document.getElementById('e_birthday').value     = birthday;
            document.getElementById('e_height').value       = height;
            document.getElementById('e_children').value     = children;
            document.getElementById('e_department').value   = department;
            document.getElementById('e_position').value     = position;
            document.getElementById('e_brigade').value      = brigade;
            document.getElementById('e_hired').value        = hired;
            document.getElementById('e_salary').value       = salary;
            new bootstrap.Modal(document.getElementById('editModal')).show();
        }

        function submitEdit() {
            const id    = document.getElementById('editId').value;
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            const body  = new URLSearchParams({
                '__RequestVerificationToken': token,
                'CurrentJob.last_name':    document.getElementById('e_last_name').value,
                'CurrentJob.first_name':   document.getElementById('e_first_name').value,
                'CurrentJob.middle_name':  document.getElementById('e_middle_name').value,
                'CurrentJob.gender':       document.querySelector('input[name="e_gender"]:checked')?.value ?? '',
                'CurrentJob.birthday':     document.getElementById('e_birthday').value,
                'CurrentJob.height':       document.getElementById('e_height').value,
                'CurrentJob.children':     document.getElementById('e_children').value,
                'CurrentJob.department':   document.getElementById('e_department').value,
                'CurrentJob.position':     document.getElementById('e_position').value,
                'CurrentJob.brigade':      document.getElementById('e_brigade').value,
                'CurrentJob.hired':        document.getElementById('e_hired').value,
                'CurrentJob.salary':       document.getElementById('e_salary').value,
            });
            fetch(`?handler=Update&id=${id}`, { method: 'POST', body })
                .then(r => r.json())
                .then(d => { if (d.success) location.reload(); else alert('Помилка!'); });
        }

        let deleteId = null;
        function openDelete(id, name) {
            deleteId = id;
            document.getElementById('deleteName').textContent = name;
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }

        function confirmDelete() {
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            fetch(`?handler=Delete&id=${deleteId}`, {
                method: 'POST',
                body: new URLSearchParams({ '__RequestVerificationToken': token })
            }).then(r => r.json()).then(d => { if (d.success) location.reload(); });
        }
    </script>
}
